<div class="change-password-container">
  <div class="change-password-card">
    <div class="card-header">
      <mat-icon class="header-icon">security</mat-icon>
      <h1>Change Password</h1>
      <p>Enter your current password and choose a new secure password.</p>
    </div>

    <form [formGroup]="changePasswordForm" (ngSubmit)="onSubmit()" class="change-password-form">
      <div class="form-field">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Current Password</mat-label>
          <input
            matInput
            [type]="passwordVisible.current ? 'text' : 'password'"
            formControlName="currentPassword"
            placeholder="Enter your current password"
            autocomplete="current-password">
          <button
            mat-icon-button
            matSuffix
            type="button"
            (click)="togglePasswordVisibility('current')"
            [attr.aria-label]="'Toggle current password visibility'">
            <mat-icon>{{passwordVisible.current ? 'visibility_off' : 'visibility'}}</mat-icon>
          </button>
          <mat-error *ngIf="changePasswordForm.get('currentPassword')?.invalid && changePasswordForm.get('currentPassword')?.touched">
            <ng-container *ngIf="changePasswordForm.get('currentPassword')?.errors?.['required']">
              Current password is required
            </ng-container>
            <ng-container *ngIf="changePasswordForm.get('currentPassword')?.errors?.['minlength']">
              Current password must be at least 8 characters
            </ng-container>
          </mat-error>
        </mat-form-field>
      </div>

      <div class="form-field">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>New Password</mat-label>
          <input
            matInput
            [type]="passwordVisible.new ? 'text' : 'password'"
            formControlName="newPassword"
            placeholder="Enter your new password"
            autocomplete="new-password">
          <button
            mat-icon-button
            matSuffix
            type="button"
            (click)="togglePasswordVisibility('new')"
            [attr.aria-label]="'Toggle new password visibility'">
            <mat-icon>{{passwordVisible.new ? 'visibility_off' : 'visibility'}}</mat-icon>
          </button>
          <mat-error *ngIf="changePasswordForm.get('newPassword')?.invalid && changePasswordForm.get('newPassword')?.touched">
            <ng-container *ngIf="changePasswordForm.get('newPassword')?.errors?.['required']">
              New password is required
            </ng-container>
            <ng-container *ngIf="changePasswordForm.get('newPassword')?.errors?.['minlength']">
              Password must be at least 12 characters
            </ng-container>
            <ng-container *ngIf="changePasswordForm.get('newPassword')?.errors?.['maxlength']">
              Password cannot exceed 100 characters
            </ng-container>
            <ng-container *ngIf="changePasswordForm.get('newPassword')?.errors?.['pattern']">
              Password must contain at least one uppercase letter, one lowercase letter, one number, and one special character
            </ng-container>
          </mat-error>
        </mat-form-field>

        <!-- Password strength indicator -->
        <div class="password-strength" *ngIf="changePasswordForm.get('newPassword')?.touched && !changePasswordForm.get('newPassword')?.errors?.['required'] && !changePasswordForm.get('newPassword')?.errors?.['minlength'] && !changePasswordForm.get('newPassword')?.errors?.['maxlength'] && !changePasswordForm.get('newPassword')?.errors?.['pattern']">
          <div class="strength-bar">
            <div class="strength-fill" [ngClass]="getPasswordStrengthClass()"></div>
          </div>
          <div class="strength-text" [ngClass]="getPasswordStrengthClass()">
            {{getPasswordStrengthText()}}
          </div>
        </div>
      </div>

      <div class="form-field">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Confirm New Password</mat-label>
          <input
            matInput
            [type]="passwordVisible.confirm ? 'text' : 'password'"
            formControlName="confirmPassword"
            placeholder="Confirm your new password"
            autocomplete="new-password">
          <button
            mat-icon-button
            matSuffix
            type="button"
            (click)="togglePasswordVisibility('confirm')"
            [attr.aria-label]="'Toggle confirm password visibility'">
            <mat-icon>{{passwordVisible.confirm ? 'visibility_off' : 'visibility'}}</mat-icon>
          </button>
          <mat-error *ngIf="changePasswordForm.get('confirmPassword')?.invalid && changePasswordForm.get('confirmPassword')?.touched">
            <ng-container *ngIf="changePasswordForm.get('confirmPassword')?.errors?.['required']">
              Please confirm your new password
            </ng-container>
            <ng-container *ngIf="changePasswordForm.errors?.['passwordMismatch']">
              Passwords do not match
            </ng-container>
          </mat-error>
        </mat-form-field>
      </div>

      <div class="form-actions">
        <button
          type="submit"
          mat-raised-button
          color="primary"
          [disabled]="changePasswordForm.invalid || isLoading"
          class="submit-button">
          <mat-icon *ngIf="!isLoading">lock_open</mat-icon>
          <mat-icon *ngIf="isLoading" class="spinning">refresh</mat-icon>
          <span class="button-text">Change Password</span>
        </button>
      </div>
    </form>

    <div class="card-footer">
      <p>
        <a routerLink="/dashboard" class="link">Back to Dashboard</a>
      </p>
    </div>
  </div>
</div>