# Implementation Plan: Multi-Tenant Authentication & User Management

**Branch**: `001-multi-tenant-auth` | **Date**: 2025-02-03 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `001-multi-tenant-auth/spec.md`

---

## Summary

EXECORA Multi-Tenant Authentication & User Management is a foundational security feature that enables:
- User self-registration with automatic tenant creation
- Email-based verification and password reset flows
- Secure JWT-based authentication with refresh token rotation
- User invitation system for tenant collaboration
- Multi-tenant user access with role-based permissions
- Strict data isolation between tenants

The implementation leverages existing EXECORA infrastructure (Tenant, User, TenantUser entities) and extends authentication services (AuthorizationService, RefreshTokenService) to create a complete identity management system.

---

## Technical Context

**Language/Version**: C# 13 (.NET 9.0), TypeScript 5.6 (Angular 19)
**Primary Dependencies**:
- Backend: ASP.NET Core Identity 9.0, EF Core 9.0, JWTBearer Authentication, BCrypt.Net-Next
- Frontend: Angular 19, RxJS 7, Angular Auth Library (optional)
**Storage**: SQL Server 2022 with Row-Level Security (RLS)
**Testing**: xUnit + Moq (backend), Jasmine + Playwright (frontend)
**Target Platform**: Azure App Service (backend), Azure Static Web Apps (frontend)
**Project Type**: Web application (backend API + Angular SPA)
**Performance Goals**:
- API Response: <200ms p95 for standard CRUD
- Login: <2s end-to-end
- Token refresh: <500ms
- Concurrent Users: 1,000+ per tenant
**Constraints**:
- Multi-tenant data isolation (RLS enforced)
- Immutable audit trail for security events
- Password security: 12+ chars, mixed case, numbers, special chars
- Email delivery dependency for verification flows
**Scale/Scope**:
- 7 prioritized user stories (6 P1, 1 P2)
- 50 functional requirements
- 7 core entities (Tenant, User, TenantUser, Invitation, RefreshToken, AuditLog, Role)
- 14 API endpoints (registration, login, password reset, invitations)

---

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

**Status**: PASSED

The constitution file is in template form with no defined principles yet. Using industry best practices as defaults:

| Principle | Status | Notes |
|-----------|:------:|-------|
| Test-First Development | Pending | TDD will be enforced during implementation |
| Clean Architecture | Pass | Existing project follows Core/Infrastructure/API separation |
| Multi-Tenant Isolation | Pass | Row-Level Security designed; TenantId on all entities |
| API-First Design | Pass | OpenAPI contracts will be defined before implementation |
| Audit Trail | Pass | Immutable audit log designed for security events |
| Security First | Pass | Password hashing, JWT, rate limiting specified |

No violations detected. Complexity tracking not required.

---

## Project Structure

### Documentation (this feature)

```text
specs/001-multi-tenant-auth/
├── plan.md              # This file
├── research.md          # Research findings (referenced from master)
├── data-model.md        # Entity definitions (referenced from master)
├── quickstart.md        # Developer setup guide
├── contracts/           # OpenAPI specifications
│   ├── auth-api.yaml    # Authentication and user management APIs
│   └── invitation-api.yaml # Invitation and tenant management APIs
└── tasks.md             # Generated by /speckit.tasks
```

### Source Code (repository root)

```text
backend/
├── src/
│   ├── Execora.Core/              # Domain layer (existing - will be extended)
│   │   ├── Entities/
│   │   │   ├── Tenant.cs          # Existing
│   │   │   ├── User.cs            # Existing
│   │   │   ├── TenantUser.cs      # Existing
│   │   │   ├── Invitation.cs      # NEW
│   │   │   ├── RefreshToken.cs    # NEW
│   │   │   └── AuditLog.cs        # NEW
│   │   ├── Enums/
│   │   │   ├── TenantRole.cs      # Existing
│   │   │   ├── InvitationStatus.cs # NEW
│   │   │   └── AuditAction.cs     # NEW
│   │   └── Interfaces/
│   │       ├── IUserRepository.cs      # Existing
│   │       ├── ITenantRepository.cs    # Existing
│   │       ├── IInvitationRepository.cs # NEW
│   │       └── IRefreshTokenRepository.cs # NEW
│   │
│   ├── Execora.Application/       # Application layer (existing - will be extended)
│   │   ├── Services/
│   │   │   ├── IAuthenticationService.cs    # NEW
│   │   │   ├── AuthenticationService.cs     # NEW
│   │   │   ├── IRegistrationService.cs      # NEW
│   │   │   ├── RegistrationService.cs       # NEW
│   │   │   ├── IPasswordResetService.cs     # NEW
│   │   │   ├── PasswordResetService.cs      # NEW
│   │   │   ├── IInvitationService.cs        # NEW
│   │   │   ├── InvitationService.cs         # NEW
│   │   │   └── IEmailService.cs             # NEW (interface only)
│   │   ├── DTOs/
│   │   │   ├── RegisterRequest.cs           # NEW
│   │   │   ├── RegisterResponse.cs          # NEW
│   │   │   ├── LoginRequest.cs              # NEW
│   │   │   ├── LoginResponse.cs             # NEW
│   │   │   ├── RefreshTokenRequest.cs       # NEW
│   │   │   ├── RefreshTokenResponse.cs      # NEW
│   │   │   ├── PasswordResetRequest.cs      # NEW
│   │   │   ├── InvitationCreateRequest.cs   # NEW
│   │   │   └── InvitationResponse.cs        # NEW
│   │   └── Validators/
│   │       └── RegistrationValidator.cs     # NEW (FluentValidation)
│   │
│   ├── Execora.Infrastructure/   # Infrastructure layer (existing - will be extended)
│   │   ├── Data/
│   │   │   ├── AppDbContext.cs             # Extend with new entities
│   │   │   └── Migrations/                  # EF Migrations for new tables
│   │   ├── Repositories/
│   │   │   ├── UserRepository.cs           # Extend with new methods
│   │   │   ├── TenantRepository.cs         # Extend with new methods
│   │   │   ├── InvitationRepository.cs     # NEW
│   │   │   └── RefreshTokenRepository.cs   # NEW
│   │   └── Services/
│   │       └── Email/
│   │           ├── IEmailService.cs         # NEW
│   │           └── SmtpEmailService.cs      # NEW
│   │
│   ├── Execora.Auth/            # Authentication module (existing - will be extended)
│   │   ├── Services/
│   │   │   ├── ITokenService.cs             # Extend with new claims
│   │   │   ├── TokenService.cs              # Existing - extend
│   │   │   ├── IRefreshTokenService.cs      # Existing
│   │   │   ├── RefreshTokenService.cs       # Existing - extend to use DB
│   │   │   ├── IPasswordHasher.cs           # NEW
│   │   │   └── PasswordHasher.cs            # NEW
│   │   └── Policies/
│   │       └── TenantAccessPolicy.cs        # NEW
│   │
│   └── Execora.Api/             # Web API (existing - will be extended)
│       ├── Controllers/
│       │   ├── Auth/
│       │   │   ├── RegisterController.cs    # NEW
│       │   │   ├── LoginController.cs       # NEW
│       │   │   ├── TokenController.cs       # NEW
│       │   │   └── PasswordController.cs    # NEW
│       │   └── User/
│       │       ├── InvitationController.cs  # NEW
│       │       ├── TenantController.cs      # NEW
│       │       └── ProfileController.cs     # NEW
│       ├── Middleware/
│       │   ├── TenantResolutionMiddleware.cs   # Extend
│       │   └── RateLimitMiddleware.cs          # NEW
│       └── Filters/
│           └── GlobalExceptionFilter.cs        # Extend for auth errors
│
└── tests/
    ├── Execora.Tests.Unit/
    │   ├── Services/
    │   │   ├── AuthenticationServiceTests.cs      # NEW
    │   │   ├── RegistrationServiceTests.cs       # NEW
    │   │   ├── PasswordResetServiceTests.cs      # NEW
    │   │   └── InvitationServiceTests.cs         # NEW
    │   └── Validators/
    │       └── RegistrationValidatorTests.cs     # NEW
    │
    └── Execora.Tests.Integration/
        ├── Controllers/
        │   ├── RegisterTests.cs                  # NEW
        │   ├── LoginTests.cs                     # NEW
        │   └── InvitationTests.cs                # NEW
        └── Helpers/
            └── TestFixture.cs                    # Extend

frontend/
├── src/
│   ├── app/
│   │   ├── core/
│   │   │   ├── services/
│   │   │   │   ├── auth.service.ts              # NEW
│   │   │   │   ├── token.service.ts             # NEW
│   │   │   │   └── user.service.ts              # NEW
│   │   │   ├── guards/
│   │   │   │   ├── auth.guard.ts                # NEW
│   │   │   │   └── tenant.guard.ts              # NEW
│   │   │   ├── interceptors/
│   │   │   │   ├── auth.interceptor.ts          # NEW
│   │   │   │   ├── tenant.interceptor.ts        # NEW
│   │   │   │   └── error.interceptor.ts         # Extend
│   │   │   └── models/
│   │   │       ├── auth.models.ts               # NEW
│   │   │       └── user.models.ts               # NEW
│   │   ├── shared/
│   │   │   ├── components/
│   │   │   │   ├── tenant-switcher/             # NEW
│   │   │   │   └── password-strength/           # NEW
│   │   │   └── layouts/
│   │   │       └── auth-layout/                 # NEW
│   │   └── features/
│   │       └── auth/
│   │           ├── register/
│   │           │   ├── register.component.ts    # NEW
│   │           │   ├── register.component.html  # NEW
│   │           │   └── register.component.spec.ts # NEW
│   │           ├── login/
│   │           │   ├── login.component.ts       # NEW
│   │           │   ├── login.component.html     # NEW
│   │           │   └── login.component.spec.ts  # NEW
│   │           ├── verify-email/
│   │           │   ├── verify-email.component.ts    # NEW
│   │           │   └── verify-email.component.html  # NEW
│   │           ├── forgot-password/
│   │           │   ├── forgot-password.component.ts # NEW
│   │           │   └── forgot-password.component.html # NEW
│   │           ├── reset-password/
│   │           │   ├── reset-password.component.ts  # NEW
│   │           │   └── reset-password.component.html # NEW
│   │           ├── accept-invitation/
│   │           │   ├── accept-invitation.component.ts # NEW
│   │           │   └── accept-invitation.component.html # NEW
│   │           └── users/
│   │               ├── user-list/
│   │               │   ├── user-list.component.ts   # NEW
│   │               │   └── user-list.component.html # NEW
│   │               └── invite-user/
│   │                   ├── invite-user.component.ts  # NEW
│   │                   └── invite-user.component.html # NEW
│   └── assets/
│       └── i18n/
│           └── en.json                            # Extend with auth strings
│
└── tests/
    ├── unit/
    │   ├── services/
    │   │   ├── auth.service.spec.ts              # NEW
    │   │   └── token.service.spec.ts             # NEW
    │   └── guards/
    │       └── auth.guard.spec.ts                # NEW
    │
    └── e2e/
        ├── auth-flow.spec.ts                      # NEW
        ├── registration.spec.ts                   # NEW
        └── password-reset.spec.ts                # NEW
```

**Structure Decision**: Web application architecture with backend (.NET) and frontend (Angular). Backend follows Clean Architecture principles (Core, Application, Infrastructure, API). Frontend uses modular Angular architecture with feature-based organization. The existing project structure is extended rather than restructured.

---

## Phase 0: Research & Technology Decisions

**Status**: COMPLETE

Research findings are documented in the master specification:
- [research.md](../master/research.md) - Backend: .NET 9.0, EF Core 9.0, ASP.NET Core Identity, JWT
- [research.md](../master/research.md) - Frontend: Angular 19, RxJS 7, Tailwind CSS 4.x
- [research.md](../master/research.md) - Database: SQL Server 2022 with Row-Level Security
- [research.md](../master/research.md) - Auth: ASP.NET Core Identity + JWT + Role-Based Claims
- [research.md](../master/research.md) - Password Hashing: BCrypt.Net-Next (Argon2 alternative)

**Feature-Specific Decisions**:

| Decision | Choice | Rationale |
|----------|--------|-----------|
| Password Hashing | BCrypt.Net-Next | Proven, widely adopted, auto-adjusts work factor |
| Token Storage | HttpOnly Cookies (frontend) + Database (backend) | Secure against XSS, enables revocation |
| Email Service | SMTP with SendGrid (Azure-compatible) | Industry standard, reliable delivery |
| Rate Limiting | ASP.NET Middleware (IP-based) | Built-in, no external dependencies |
| Session Management | Refresh Token Rotation | Security best practice, limits token theft impact |

---

## Phase 1: Design & Contracts

### 1.1 Data Model Extensions

The following entities are added to support authentication and user management:

#### Invitation
```csharp
public class Invitation : BaseEntity
{
    public Guid Id { get; set; }
    public Guid TenantId { get; set; }
    public string Email { get; set; }
    public TenantRole Role { get; set; }
    public string Token { get; set; }  // Secure random token
    public DateTime ExpiresAt { get; set; }
    public InvitationStatus Status { get; set; }
    public Guid? InvitedBy { get; set; }
    public DateTime? AcceptedAt { get; set; }

    // Navigation
    public Tenant Tenant { get; set; }
}
```

#### RefreshToken
```csharp
public class RefreshToken : BaseEntity
{
    public Guid Id { get; set; }
    public Guid UserId { get; set; }
    public string TokenHash { get; set; }  // SHA-256 hash
    public DateTime ExpiresAt { get; set; }
    public string? DeviceIdentifier { get; set; }
    public bool IsRevoked { get; set; }
    public DateTime? RevokedAt { get; set; }
}
```

#### AuditLog
```csharp
public class AuditLog : BaseEntity
{
    public Guid Id { get; set; }
    public Guid? TenantId { get; set; }
    public string EntityName { get; set; }
    public Guid? EntityId { get; set; }
    public AuditAction Action { get; set; }
    public string? ActionType { get; set; }
    public string? OldValues { get; set; }  // JSON
    public string? NewValues { get; set; }  // JSON
    public Guid? ChangedBy { get; set; }
    public string? ChangedByType { get; set; }
    public DateTime ChangedAt { get; set; }
    public string? IpAddress { get; set; }
    public string? UserAgent { get; set; }
}
```

**Relationships**:
```
Tenant (1) ----< (N) Invitation
Tenant (1) ----< (N) AuditLog
User (1) ----< (N) RefreshToken
User (1) ----< (N) AuditLog (as ChangedBy)
```

### 1.2 API Contracts

#### Authentication API (`contracts/auth-api.yaml`)

| Endpoint | Method | Description |
|----------|--------|-------------|
| `/api/auth/register` | POST | Register new user + create tenant |
| `/api/auth/verify-email` | POST | Verify email with token |
| `/api/auth/resend-verification` | POST | Resend verification email |
| `/api/auth/login` | POST | Authenticate user, return tokens |
| `/api/auth/refresh` | POST | Exchange refresh token for access token |
| `/api/auth/logout` | POST | Invalidate refresh token |
| `/api/auth/forgot-password` | POST | Request password reset |
| `/api/auth/reset-password` | POST | Reset password with token |
| `/api/auth/change-password` | POST | Change password (authenticated) |

#### User & Invitation API (`contracts/invitation-api.yaml`)

| Endpoint | Method | Description |
|----------|--------|-------------|
| `/api/app/users/invite` | POST | Send tenant invitation |
| `/api/app/users/invitations` | GET | List pending invitations |
| `/api/app/users/invitations/{id}/cancel` | POST | Cancel invitation |
| `/api/app/users/invitations/{id}/resend` | POST | Resend invitation |
| `/api/app/users` | GET | List tenant users |
| `/api/app/users/{id}` | PUT | Update user role |
| `/api/app/users/{id}` | DELETE | Remove user from tenant |
| `/api/app/users/me` | GET | Current user profile |
| `/api/app/users/me` | PUT | Update current user |
| `/api/app/tenants` | GET | List user's tenants |
| `/api/app/tenants/{id}/switch` | POST | Switch active tenant |

### 1.3 Security Considerations

1. **Rate Limiting**:
   - Login: 5 attempts per 15 minutes per IP
   - Registration: 3 attempts per hour per IP
   - Password Reset: 3 attempts per hour per email
   - Invitation: 10 per hour per tenant

2. **Token Security**:
   - Access Token: 15 minute lifetime
   - Refresh Token: 7 day standard, 30 day "remember me"
   - Refresh Token Rotation on every use
   - Tokens stored in HttpOnly cookies

3. **Password Requirements**:
   - Minimum 12 characters
   - Must contain uppercase, lowercase, number, special character
   - Cannot reuse last 5 passwords
   - History stored as hash (not plaintext)

4. **Data Isolation**:
   - All queries filtered by TenantId
   - Row-Level Security at database level
   - Audit trail for all tenant access changes

---

## Phase 2: Implementation Phases

### Phase 2.1: Core Authentication (P1)

**Backend Tasks**:
1. Implement `PasswordHasher` using BCrypt.Net-Next
2. Create `AuthenticationService` with login/register logic
3. Extend `TokenService` with tenant/user claims
4. Implement `RefreshTokenRepository` with database backing
5. Create `RegisterController` and `LoginController`
6. Add rate limiting middleware
7. Implement audit logging for auth events

**Frontend Tasks**:
1. Create `AuthService` with HTTP interceptor
2. Create `TokenService` for token management
3. Build login page with form validation
4. Build registration page with organization details
5. Implement email verification page
6. Add `AuthGuard` for protected routes
7. Add `AuthInterceptor` for token injection

### Phase 2.2: Password Management (P1)

**Backend Tasks**:
1. Create `PasswordResetService`
2. Implement forgot password endpoint
3. Implement reset password endpoint
4. Add password history tracking
5. Implement change password endpoint

**Frontend Tasks**:
1. Build forgot password page
2. Build reset password page
3. Add password change form in user profile
4. Add password strength indicator component

### Phase 2.3: User Invitation (P1)

**Backend Tasks**:
1. Create `Invitation` entity and repository
2. Create `InvitationService` with email sending
3. Implement invitation endpoints (create, list, cancel, resend)
4. Create invitation acceptance flow
5. Add user management endpoints (list, update role, remove)

**Frontend Tasks**:
1. Build invite user modal/form
2. Create pending invitations list
3. Build invitation acceptance page
4. Create user list page for tenant admins
5. Add role assignment dropdown

### Phase 2.4: Multi-Tenant Access (P2)

**Backend Tasks**:
1. Create tenant listing endpoint
2. Implement tenant switching logic
3. Update token claims on tenant switch
4. Audit log tenant switches

**Frontend Tasks**:
1. Create tenant switcher component
2. Store last active tenant in preferences
3. Redirect to last active tenant on login
4. Update UI on tenant switch

### Phase 2.5: Testing & Polish

**Tasks**:
1. Unit tests for all services (80%+ coverage target)
2. Integration tests for API endpoints
3. E2E tests for critical flows (login, register, password reset)
4. Performance testing (concurrent users, token refresh)
5. Security testing (SQL injection, XSS, CSRF)
6. Load testing (1,000+ concurrent users)

---

## Dependencies

### Internal
- Existing `Tenant`, `User`, `TenantUser` entities
- Existing `AuthorizationService` policies
- Existing `RefreshTokenService` (needs extension)
- Existing `AppDbContext`

### External
- **BCrypt.Net-Next**: Password hashing
- **System.IdentityModel.Tokens.Jwt**: JWT token creation/validation
- **FluentValidation**: Request validation
- **SendGrid/Azure Communication Services**: Email delivery
- **Angular 19**: Frontend framework
- **RxJS 7**: Reactive extensions for Angular

---

## Risk Mitigation

| Risk | Impact | Mitigation |
|------|:------:|------------|
| Email delivery delays | High | Queue-based sending, retry logic, user notification |
| Token refresh complexity | Medium | Extensive testing, clear error handling |
| Multi-tenant data leakage | Critical | RLS at DB level, integration tests, audit logging |
| Password reset abuse | Medium | Rate limiting, token expiration, single-use tokens |
| Refresh token theft | High | Short expiration, rotation, HttpOnly cookies |
| Concurrent session limits | Low | Configurable limits, admin override |

---

## Success Criteria

### Functional
- [ ] Users can register and create tenant in <3 minutes
- [ ] Users can log in with valid credentials in <2 seconds
- [ ] Password reset emails delivered within 30 seconds
- [ ] Invitation emails delivered within 30 seconds
- [ ] Users can switch between tenants in <1 second
- [ ] 95% of users complete email verification within 24 hours

### Non-Functional
- [ ] System supports 1,000 concurrent users per tenant
- [ ] Token refresh completes in <500ms
- [ ] Zero data leakage between tenants (penetration tested)
- [ ] All security events logged with 100% accuracy
- [ ] Rate limiting prevents brute force attacks

### Quality
- [ ] 80%+ unit test coverage
- [ ] All critical flows covered by E2E tests
- [ ] No high-severity security vulnerabilities
- [ ] API documentation complete (OpenAPI/Swagger)

---

## Next Steps

1. **Generate API Contracts**: Create `contracts/auth-api.yaml` and `contracts/invitation-api.yaml`
2. **Create Quickstart Guide**: Document local development setup
3. **Run `/speckit.tasks`**: Generate actionable implementation tasks
4. **Begin Implementation**: Start with Phase 2.1 (Core Authentication)

---

**END OF IMPLEMENTATION PLAN**
