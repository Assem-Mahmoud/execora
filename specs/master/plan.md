# Implementation Plan: EXECORA Construction Execution Platform

**Branch**: `master` | **Date**: 2025-02-03 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `EXECORA_Complete_Product_Specification_MultiTenant_v2.md`

---

## Summary

EXECORA is a **multi-tenant, workflow-driven construction execution platform** designed to enforce how projects are delivered. The system features:

- **Multi-tenant SaaS architecture** with strict data isolation
- **Workflow Engine** using Finite State Machine (FSM) for enforced execution
- **10 integrated modules**: Project Management, Daily Operations, Activities, Inspections, Issues, NCR, Workflows, BIM, Dashboards, Notifications
- **Tiered subscription plans**: Core, Professional, Enterprise
- **Role-based access control** with System Admin, Tenant Admin, and Project-level roles

**Technical Approach**:
- Backend: .NET 9.0 with modular architecture
- Frontend: Angular 19 with standalone components and Tailwind CSS
- Database: SQL Server 2022 with Row-Level Security for multi-tenancy
- BIM: Autodesk Platform Services (APS) integration
- Hosting: Azure (App Service, SQL Database, Blob Storage)

---

## Technical Context

**Language/Version**: .NET 9.0 (C# 13), TypeScript 5.6 (Angular 19)
**Primary Dependencies**:
  - Backend: EF Core 9.0, ASP.NET Core Identity, SignalR, APS SDK
  - Frontend: Angular 19, RxJS 7, Tailwind CSS 4.x, APS Viewer SDK
**Storage**: SQL Server 2022 (relational), Azure Blob Storage (files)
**Testing**: xUnit + Moq (backend), Jasmine + Playwright (frontend)
**Target Platform**: Azure cloud services
**Project Type**: Web application (backend API + Angular SPA)
**Performance Goals**:
  - API Response: <200ms p95 for standard CRUD
  - Page Load: <2s initial load, <500ms subsequent navigation
  - Concurrent Users: 1000+ per tenant
**Constraints**:
  - Multi-tenant data isolation (RLS)
  - Immutable audit trail
  - Workflow state machine consistency
  - Offline capability for field operations
**Scale/Scope**:
  - 10 core modules with 50+ entities
  - 40+ frontend pages/components
  - System admin + tenant admin + project user interfaces

---

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

**Status**: PASSED ✓

The constitution file is in template form with no defined principles yet. Using industry best practices as defaults:

| Principle | Status | Notes |
|-----------|:------:|-------|
| Test-First Development | ⚠️ Pending | TDD will be enforced during implementation |
| Modular Architecture | ✓ Pass | Clear separation of concerns (Core, Infrastructure, Application, API) |
| Multi-Tenant Isolation | ✓ Pass | Row-Level Security ensures data separation |
| API-First Design | ✓ Pass | OpenAPI contracts defined before implementation |
| Audit Trail | ✓ Pass | Immutable audit log designed |

---

## Project Structure

### Documentation (this feature)

```text
specs/master/
├── spec.md              # Feature specification (multi-tenant EXECORA)
├── plan.md              # This file (implementation plan)
├── research.md          # Technology decisions and research
├── data-model.md        # Entity definitions and relationships
├── quickstart.md        # Developer setup guide
├── contracts/           # OpenAPI specifications
│   ├── system-api.yaml  # System administration APIs
│   └── application-api.yaml # Tenant-facing application APIs
└── tasks.md             # Generated by /speckit.tasks (NOT created yet)
```

### Source Code (repository root)

```text
EXECORA/
├── backend/                         # .NET Solution
│   ├── src/
│   │   ├── Execora.Api/             # Web API entry point
│   │   │   ├── Controllers/         # API endpoints
│   │   │   │   ├── Sys/             # System admin APIs
│   │   │   │   └── App/             # Tenant APIs
│   │   │   ├── Middleware/          # Custom middleware (tenant, auth)
│   │   │   ├── Filters/             # Global exception handling
│   │   │   └── Program.cs
│   │   ├── Execora.Core/            # Domain layer
│   │   │   ├── Entities/            # Domain entities
│   │   │   ├── Interfaces/          # Repository interfaces
│   │   │   ├── ValueObjects/        # Value objects
│   │   │   └── Specifications/      # Query specifications
│   │   ├── Execora.Application/     # Application layer
│   │   │   ├── Services/            # Business logic services
│   │   │   ├── DTOs/                # Data transfer objects
│   │   │   ├── Interfaces/          # Service interfaces
│   │   │   ├── Features/            # Feature modules (CQRS)
│   │   │   └── Validators/          # FluentValidation
│   │   ├── Execora.Infrastructure/  # Infrastructure layer
│   │   │   ├── Data/                # EF Core DbContext
│   │   │   ├── Repositories/        # Repository implementations
│   │   │   ├── Migrations/          # EF Migrations
│   │   │   ├── Services/            # External service clients
│   │   │   │   ├── AzureStorage/
│   │   │   │   ├── AutodeskAPS/
│   │   │   │   ├── Email/
│   │   │   │   └── SignalR/
│   │   │   └── Identity/            # ASP.NET Core Identity
│   │   ├── Execora.Auth/            # Authentication module
│   │   │   ├── Services/            # JWT, token management
│   │   │   ├── Policies/            # Authorization policies
│   │   │   └── Requirements/        # Authorization requirements
│   │   └── Execora.Workflow/        # Workflow Engine
│   │       ├── Engine/              # FSM implementation
│   │       ├── Definitions/         # Workflow definitions
│   │       └── Transitions/         # State transition logic
│   └── tests/
│       ├── Execora.Tests.Unit/
│       └── Execora.Tests.Integration/
│
├── frontend/                        # Angular Application
│   ├── src/
│   │   ├── app/
│   │   │   ├── core/                # Singleton services
│   │   │   │   ├── services/        # API, auth, signalr
│   │   │   │   ├── guards/          # Route guards
│   │   │   │   ├── interceptors/    # HTTP interceptors
│   │   │   │   └── models/          # Shared models
│   │   │   ├── shared/              # Shared components
│   │   │   │   ├── components/      # Generic UI components
│   │   │   │   ├── directives/      # Custom directives
│   │   │   │   ├── pipes/           # Custom pipes
│   │   │   │   └── layouts/         # Layout components
│   │   │   ├── features/            # Feature modules
│   │   │   │   ├── auth/            # Login, registration
│   │   │   │   ├── sys-admin/       # System admin UI
│   │   │   │   │   ├── organizations/
│   │   │   │   │   ├── subscriptions/
│   │   │   │   │   └── audit-logs/
│   │   │   │   ├── layout/          # App shell, nav, sidebar
│   │   │   │   ├── dashboard/       # Main dashboard
│   │   │   │   ├── projects/        # Project CRUD
│   │   │   │   ├── activities/      # Activity management
│   │   │   │   ├── inspections/     # Quality inspections
│   │   │   │   ├── issues/          # Issue tracking
│   │   │   │   ├── ncr/             # NCR management
│   │   │   │   ├── daily-ops/       # Daily reports
│   │   │   │   ├── bim/             # BIM viewer
│   │   │   │   └── settings/        # Org/user settings
│   │   │   ├── auth/                # Auth module
│   │   │   └── environments/        # Environment configs
│   │   ├── assets/
│   │   │   ├── images/
│   │   │   ├── icons/
│   │   │   └── i18n/                # Translations
│   │   ├── styles/                  # Global styles
│   │   │   └── tailwind.css
│   │   ├── index.html
│   │   └── main.ts
│   ├── angular.json
│   ├── package.json
│   └── tsconfig.json
│
├── database/                        # Database scripts
│   ├── migrations/                  # SQL migration scripts
│   └── seeds/                       # Seed data scripts
│
├── deploy/                          # Deployment configurations
│   ├── azure/
│   │   ├── app-service.json
│   │   ├── sql-database.json
│   │   └── container-apps.yaml
│   └── docker/
│       ├── backend.Dockerfile
│       └── frontend.Dockerfile
│
├── docs/                            # Additional documentation
│   ├── architecture/
│   ├── api/
│   └── user-guides/
│
├── specs/                           # Specifications
│   └── master/
│
├── .gitignore
├── README.md
└── solution.sln
```

**Structure Decision**: Web application architecture with clear separation between backend (.NET) and frontend (Angular). Backend follows Clean Architecture principles (Core, Application, Infrastructure, API). Frontend uses modular architecture with feature-based organization.

---

## Implementation Phases

### Phase 0: Foundation & Infrastructure ✅ COMPLETE

**Status**: Completed - Research and technology decisions finalized.

**Deliverables**:
- ✓ `research.md` - Technology stack decisions with rationale
- ✓ `data-model.md` - Complete entity definitions and relationships
- ✓ `contracts/system-api.yaml` - System admin API specification
- ✓ `contracts/application-api.yaml` - Tenant-facing API specification
- ✓ `quickstart.md` - Developer setup guide

**Key Decisions**:
- .NET 9.0 for backend (enterprise-grade, modular services)
- Angular 19 for frontend (enterprise SPA with offline capability)
- SQL Server 2022 with Row-Level Security (multi-tenant isolation)
- Autodesk Platform Services for BIM integration
- Azure cloud services for deployment

---

### Phase 1: Core Platform (MVP Foundation)

**Goal**: Build multi-tenant core with authentication and basic project management.

**Backend Modules**:
1. **Infrastructure Setup**
   - Solution structure and projects
   - EF Core DbContext with entities
   - Row-Level Security for multi-tenancy
   - Migration framework

2. **Authentication & Authorization**
   - ASP.NET Core Identity integration
   - JWT token service
   - Role-based authorization policies
   - Tenant resolution middleware

3. **User & Tenant Management**
   - Tenant CRUD operations
   - User CRUD operations
   - Tenant-User membership
   - Invitation system

4. **Project Module**
   - Project CRUD
   - Organization management
   - Project membership
   - Trade definitions

**Frontend Modules**:
1. **Core Framework**
   - App shell with navigation
   - Authentication service
   - HTTP interceptors (auth, tenant, error)
   - Route guards
   - Shared component library

2. **Auth Module**
   - Login page
   - Token refresh
   - Tenant selection (multi-tenant users)

3. **Layout Module**
   - Sidebar navigation
   - Header with user menu
   - Breadcrumb navigation

4. **Project Module**
   - Project list
   - Project create/edit
   - Project detail view

**Estimated Scope**: ~3-4 weeks

---

### Phase 2: Execution Core (Core Plan Features)

**Goal**: Implement daily operations, activities, and basic issues.

**Backend Modules**:
1. **Activities Module**
   - Activity CRUD
   - Parent-child relationships (WBS)
   - Progress tracking
   - Activity history

2. **Daily Operations Module**
   - Daily reports
   - Manpower entries
   - Weather data (API integration optional)

3. **Issues Module (Basic)**
   - Issue CRUD
   - Severity & SLA tracking
   - Issue comments
   - Basic escalations

**Frontend Modules**:
1. **Activities Module**
   - Activity list/tree view
   - Activity create/edit
   - Progress update
   - Activity detail

2. **Daily Ops Module**
   - Daily report form
   - Daily report list
   - Manpower entry

3. **Issues Module**
   - Issue list with filters
   - Issue create/edit
   - Issue detail with comments
   - Issue dashboard

**Estimated Scope**: ~3-4 weeks

---

### Phase 3: Quality & Workflow (Professional Plan)

**Goal**: Implement inspections, NCR, and the core workflow engine.

**Backend Modules**:
1. **Workflow Engine**
   - Finite State Machine implementation
   - Workflow definitions (JSON)
   - State transition service
   - Transition audit trail
   - Workflow instance management

2. **Inspections Module**
   - Inspection templates
   - Inspection CRUD
   - Checklist handling
   - Inspection submission (pass/fail)
   - Re-inspection workflow

3. **NCR Module**
   - NCR CRUD
   - Auto-generation from failed inspections
   - Root cause analysis workflow
   - Corrective/preventive actions
   - NCR verification and closure
   - Activity locking on NCR

**Frontend Modules**:
1. **Inspections Module**
   - Template management
   - Inspection scheduling
   - Mobile-friendly inspection form
   - Checklist components
   - Inspection submission

2. **NCR Module**
   - NCR list/dashboard
   - NCR detail view
   - RCA form
   - Corrective action workflow
   - NCR verification

3. **Workflow UI Components**
   - Status indicators
   - Workflow visualization
   - State transition buttons (authorized)

**Estimated Scope**: ~5-6 weeks

---

### Phase 4: BIM Integration (Professional Plan)

**Goal**: Integrate Autodesk Platform Services for 3D model viewing.

**Backend Modules**:
1. **BIM Services**
   - APS authentication (3-legged OAuth)
   - Model upload to APS
   - Derivative processing
   - Token generation for viewer
   - Element mapping storage

**Frontend Modules**:
1. **BIM Viewer Module**
   - APS Viewer integration
   - Model selection
   - Element selection
   - Color-coding by workflow state
   - Element linking (to Activities, Inspections, NCRs)
   - Snapshot generation

**Estimated Scope**: ~3-4 weeks

---

### Phase 5: Dashboards & Analytics

**Goal**: Provide management insights and reporting.

**Backend Modules**:
1. **Analytics Services**
   - Dashboard aggregation queries
   - Progress calculation services
   - Risk scoring
   - Trend analysis

2. **Reports Module**
   - Report generation
   - Report templates
   - Export services (PDF, Excel)

**Frontend Modules**:
1. **Dashboards Module**
   - Project dashboard
   - Executive summary
   - Quality trends
   - Risk heatmaps
   - Power BI embedded (optional)

2. **Reports Module**
   - Report builder
   - Report viewer
   - Export functionality

**Estimated Scope**: ~3 weeks

---

### Phase 6: System Administration

**Goal**: Build EXECORA internal tools for tenant and subscription management.

**Backend Modules**:
1. **System Admin APIs**
   - Tenant management
   - Subscription management
   - Usage reporting
   - System audit logs
   - Tenant impersonation

**Frontend Modules**:
1. **Sys Admin Module**
   - Tenant management UI
   - Subscription assignment
   - Usage dashboard
   - Audit log viewer
   - Impersonation UI with banner

**Estimated Scope**: ~2-3 weeks

---

### Phase 7: Advanced Features (Enterprise)

**Goal**: Portfolio management, custom workflows, advanced notifications.

**Backend Modules**:
1. **Portfolio Services**
   - Cross-project analytics
   - Portfolio dashboards
   - Aggregated reporting

2. **Custom Workflow Builder**
   - Workflow definition builder
   - Custom state machines
   - Workflow versioning

3. **Notification Engine**
   - SignalR real-time notifications
   - Email notification service
   - Notification preferences
   - Notification templates

**Frontend Modules**:
1. **Portfolio Module**
   - Portfolio dashboard
   - Multi-project views
   - Cross-project analytics

2. **Workflow Designer**
   - Visual workflow builder
   - State definition UI
   - Transition rule builder

3. **Notifications**
   - Notification center
   - Real-time toast notifications
   - Notification preferences UI

**Estimated Scope**: ~4 weeks

---

### Phase 8: Polish & Production Readiness

**Goal**: Testing, documentation, deployment.

**Tasks**:
1. Comprehensive testing
   - Unit tests (80%+ coverage)
   - Integration tests for all APIs
   - E2E tests for critical flows
   - Performance testing
   - Security audit

2. Documentation
   - API documentation (Swagger)
   - User guides
   - Admin guides
   - Deployment documentation

3. Deployment
   - CI/CD pipeline setup
   - Azure environment configuration
   - Database migration planning
   - Backup/restore procedures
   - Monitoring and alerting

**Estimated Scope**: ~3-4 weeks

---

## Module Dependencies

```
┌─────────────────────────────────────────────────────────────────────┐
│                         EXECORA Platform                             │
├─────────────────────────────────────────────────────────────────────┤
│                                                                       │
│  ┌──────────────┐   ┌──────────────┐   ┌──────────────┐           │
│  │   Phase 1    │──▶│   Phase 2    │──▶│   Phase 3    │           │
│  │    Core      │   │  Execution   │   │   Quality    │           │
│  │              │   │              │   │              │           │
│  │ • Tenants    │   │ • Activities │   │ • Workflow   │           │
│  │ • Users      │   │ • Daily Ops  │   │   Engine     │           │
│  │ • Projects   │   │ • Issues     │   │ • Inspections│           │
│  │ • Auth       │   │              │   │ • NCR        │           │
│  └──────────────┘   └──────────────┘   └──────────────┘           │
│         │                   │                   │                  │
│         └───────────────────┼───────────────────┘                  │
│                             ▼                                      │
│  ┌──────────────────────────────────────────────────────┐         │
│  │                    Phase 4 - BIM                      │         │
│  │                    Phase 5 - Dashboards              │         │
│  └──────────────────────────────────────────────────────┘         │
│                             │                                      │
│                             ▼                                      │
│  ┌──────────────────────────────────────────────────────┐         │
│  │              Phase 6 - System Admin                   │         │
│  │              Phase 7 - Enterprise                     │         │
│  └──────────────────────────────────────────────────────┘         │
│                                                                       │
└─────────────────────────────────────────────────────────────────────┘
```

---

## Risk Mitigation

| Risk | Impact | Mitigation |
|------|:------:|------------|
| Workflow complexity | High | Start with predefined workflows; custom builder in Phase 7 |
| BIM integration delays | Medium | Phase 4 is modular; can ship without BIM for MVP |
| Multi-tenant data leaks | Critical | RLS enforced at DB level; comprehensive testing |
| Performance at scale | Medium | Caching strategy; database indexes; load testing |
| APS API limits | Low | Client-side caching; token reuse; error handling |
| Offline sync complexity | High | Initial release online-only; offline in future phase |

---

## Success Criteria

### Phase 1-3 (MVP)
- [ ] Users can create tenants and invite users
- [ ] Projects can be created and managed
- [ ] Activities can be created and progress tracked
- [ ] Inspections can be created and submitted
- [ ] Failed inspections create NCRs automatically
- [ ] NCR workflow enforces RCA before closure
- [ ] Activities lock when linked NCR is open

### Phase 4-5 (Professional)
- [ ] BIM models can be uploaded and viewed
- [ ] BIM elements link to execution entities
- [ ] Elements color-code by workflow state
- [ ] Dashboards show accurate project status
- [ ] Reports can be generated and exported

### Phase 6-7 (Enterprise)
- [ ] System admins can manage tenants
- [ ] Tenants can be assigned subscription plans
- [ ] Custom workflows can be designed
- [ ] Portfolio analytics aggregate project data
- [ ] Real-time notifications work via SignalR

---

## Next Steps

1. **Run `/speckit.tasks`** to generate the actionable task list
2. **Review** the `contracts/` folder for API specifications
3. **Set up** local development environment using `quickstart.md`
4. **Begin** Phase 1 implementation starting with infrastructure

---

**END OF IMPLEMENTATION PLAN**
